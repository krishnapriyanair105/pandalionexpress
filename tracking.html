<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Pandalion Express — Tracking</title>
    <link rel="icon" href="images/favicon.png" type="image/png">
    <link rel="shortcut icon" href="images/favicon.png?v=2" type="image/png">
    <link rel="stylesheet" href="Stylesheet.css">
</head>
<body style="align-items: center;">
<div class="wrap">
    <header>
        <div class="logo"><img src="images/pandalion_logo.png"></div>
        <div class="brand">
            <h1>Pandalion Express</h1>
            <p>Delivering happiness by tandem — cute, fast & careful</p>
        </div>
    </header>

    <main style="padding:62px">
        <!-- ORDER DETAILS CARD -->
        <table align="center" style="
            width:100%;max-width:1200px;border-radius:21px;background:white;
            border-collapse:collapse;padding:34px;box-shadow:0 18px 50px rgba(9,10,12,.06);
            border:1px solid rgba(17,17,17,.04);
        ">
            <thead>
                <tr style="height:108px;">
                    <th colspan="3" style="text-align:left;padding:25px;">
                        <div style="font-weight:700;font-size:16px;">
                            ORDER <span style="color:#ffd23f;">#INVALID</span>
                        </div>
                        <div style="font-size:13px;color:#6b7280;font-weight:400;">
                            Expected Arrival:
                            <span style="font-weight:700;">Today, between 2:00–4:00 PM</span>
                        </div>
                    </th>
                    <th colspan="3" style="text-align:right;padding:25px;">
                        <div style="font-weight:400;font-size:13px;color:#6b7280;">Courier</div>
                        <div style="font-weight:900;">Pandalion Express</div>
                    </th>
                </tr>
            </thead>

            <tbody>
                <tr>
                    <td colspan="6" style="padding:15px" align="center">
                        <div style="background:#e4dbdb;height:12px;border-radius:20px;width:96%;" align="left">
                            <div id="progressbar" style="background:#ffdc6d;height:12px;border-radius:20px;width:0%"></div>
                        </div>
                    </td>
                </tr>

                <tr align="center" style="height:100px;">
                    <td><img id="img-1" src="images/favicon.png" style="height:90px"></td>
                    <td><img id="img-2" src="images/favicon.png" style="height:90px"></td>
                    <td><img id="img-3" src="images/favicon.png" style="height:90px"></td>
                    <td><img id="img-4" src="images/favicon.png" style="height:90px"></td>
                    <td><img id="img-5" src="images/favicon.png" style="height:90px"></td>
                    <td><img id="img-6" src="images/favicon.png" style="height:90px"></td>
                </tr>

                <tr valign="top" style="font-weight:700;font-size:13px;text-align:center;color:#7d7272;">
                    <td id="1">Order Received</td>
                    <td id="2">Preparing Your Surprise</td>
                    <td id="3">Packed with Love</td>
                    <td id="4">On the Bamboo Bicycle</td>
                    <td id="5">Almost There</td>
                    <td id="6">Delivered with a Smile</td>
                </tr>
            </tbody>
        </table>

        <!-- MESSAGE CARD -->
        <table align="center" style="
            width:100%;max-width:1200px;border-radius:21px;background:white;
            border-collapse:collapse;padding:34px;box-shadow:0 18px 50px rgba(9,10,12,.06);
            border:1px solid rgba(17,17,17,.04);margin-top:10px;
        ">
            <thead>
                <tr style="height:108px;">
                    <th colspan="3" style="text-align:left;padding:25px;">
                        <div style="font-weight:700;font-size:16px;">
                            Message to <span id="messageto" style="color:#d80303;">#INVALID</span>
                        </div>
                    </th>
                </tr>
            </thead>
            <tbody>
                <tr><td id="textmessage" style="padding:20px;color:#f05631;font-weight:700;"></td></tr>
            </tbody>
        </table>
    </main>
</div>

<!-- MUST BE ABOVE YOUR SCRIPT -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
document.addEventListener("DOMContentLoaded", () => {

    /** CONFIG **/
    const SUPABASE_URL  = "https://oeriuexkhrwzblfkozss.supabase.co";
    const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9lcml1ZXhraHJ3emJsZmtvenNzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQyNjAwNjQsImV4cCI6MjA3OTgzNjA2NH0.850b53ovl1lk9iXSmgV9PJmprzsCLipIqrw03kQ2cOc";

    const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

    /** URL PARAM **/
    function getOrderId() {
        const p = new URLSearchParams(window.location.search);
        return p.get("orderid") || null;
    }
    const orderid = getOrderId();

    if (orderid) {
        document.body.innerHTML = document.body.innerHTML.replace("#INVALID", "#" + orderid);
    }

    /** STATUS BAR **/
    function updateProgress(status) {
        document.getElementById("progressbar").style.width = (16 * status) + "%";
    }

    function updateImages(status) {
        const gifs = [
            "images/order-received.gif",
            "images/packing.gif",
            "images/Panda_Giftbox_Thumbs_Up_Video.gif",
            "images/order-received.gif",
            "images/packing.gif",
            "images/Panda_Giftbox_Thumbs_Up_Video.gif"
        ];
        for (let i = 1; i <= 6; i++) {
            const img = document.getElementById("img-" + i);
            if (i <= status) { img.src = gifs[i-1]; img.style.filter = "none"; }
            else { img.src = "images/favicon.png"; img.style.filter = "grayscale(100%)"; }
        }
    }

    function updateTextColors(status) {
        for (let i = 1; i <= 6; i++) {
            let t = document.getElementById(i+"");
            t.style.color = (i <= status) ? "black" : "#7d7272";
        }
    }

    /** MAIN **/
    (async () => {
        if (!orderid) return;

        /** 1) pl_orderstatus **/
        const { data: statusRow, error: statusErr } = await sb
            .from("pl_orderstatus")
            .select("orderid, orderkey, message, status")
            .eq("orderid", orderid)
            .single();

        if (statusErr) console.log("STATUS ERROR:", statusErr);
        if (!statusRow) return;

        /** 2) pl_order **/
        const { data: orderRow, error: orderErr } = await sb
            .from("pl_order")
            .select("recipientname")
            .eq("orderkey", statusRow.orderkey)
            .single();

        if (orderErr) console.log("ORDER ERROR:", orderErr);
        if (!orderRow) return;

        /** APPLY UI **/
        document.getElementById("messageto").innerText   = orderRow.recipientname;
        document.getElementById("textmessage").innerText = statusRow.message;

        updateProgress(statusRow.status);
        updateImages(statusRow.status);
        updateTextColors(statusRow.status);
    })();
});
</script>

</body>
</html>
